(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory(require("domutils")):typeof define==="function"&&define.amd?define(["domutils"],factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.scrapy=factory(global.DomUtils))})(this,(function(DomUtils){"use strict";function _interopDefaultLegacy(e){return e&&typeof e==="object"&&"default"in e?e:{default:e}}var DomUtils__default=_interopDefaultLegacy(DomUtils);var boolbase={trueFunc:function trueFunc(){return true},falseFunc:function falseFunc(){return false}};var commonjsGlobal=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function createCommonjsModule(fn,basedir,module){return module={path:basedir,exports:{},require:function(path,base){return commonjsRequire(path,base===undefined||base===null?module.path:base)}},fn(module,module.exports),module.exports}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var parse_1=createCommonjsModule((function(module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.default=parse;var reName=/^[^\\]?(?:\\(?:[\da-f]{1,6}\s?|.)|[\w\-\u00b0-\uFFFF])+/;var reEscape=/\\([\da-f]{1,6}\s?|(\s)|.)/gi;var reAttr=/^\s*((?:\\.|[\w\u00b0-\uFFFF-])+)\s*(?:(\S?)=\s*(?:(['"])([^]*?)\3|(#?(?:\\.|[\w\u00b0-\uFFFF-])*)|)|)\s*(i)?\]/;var actionTypes={undefined:"exists","":"equals","~":"element","^":"start",$:"end","*":"any","!":"not","|":"hyphen"};var Traversals={">":"child","<":"parent","~":"sibling","+":"adjacent"};var attribSelectors={"#":["id","equals"],".":["class","element"]};var unpackPseudos=new Set(["has","not","matches"]);var stripQuotesFromPseudos=new Set(["contains","icontains"]);var quotes=new Set(['"',"'"]);function funescape(_,escaped,escapedWhitespace){var high=parseInt(escaped,16)-65536;return high!==high||escapedWhitespace?escaped:high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,high&1023|56320)}function unescapeCSS(str){return str.replace(reEscape,funescape)}function isWhitespace(c){return c===" "||c==="\n"||c==="\t"||c==="\f"||c==="\r"}function parse(selector,options){var subselects=[];selector=parseSelector(subselects,""+selector,options);if(selector!==""){throw new Error("Unmatched selector: "+selector)}return subselects}function parseSelector(subselects,selector,options){var tokens=[];var sawWS=false;function getName(){var match=selector.match(reName);if(!match){throw new Error("Expected name, found "+selector)}var sub=match[0];selector=selector.substr(sub.length);return unescapeCSS(sub)}function stripWhitespace(start){while(isWhitespace(selector.charAt(start)))start++;selector=selector.substr(start)}function isEscaped(pos){var slashCount=0;while(selector.charAt(--pos)==="\\")slashCount++;return(slashCount&1)===1}stripWhitespace(0);while(selector!==""){var firstChar=selector.charAt(0);if(isWhitespace(firstChar)){sawWS=true;stripWhitespace(1)}else if(firstChar in Traversals){tokens.push({type:Traversals[firstChar]});sawWS=false;stripWhitespace(1)}else if(firstChar===","){if(tokens.length===0){throw new Error("Empty sub-selector")}subselects.push(tokens);tokens=[];sawWS=false;stripWhitespace(1)}else{if(sawWS){if(tokens.length>0){tokens.push({type:"descendant"})}sawWS=false}if(firstChar==="*"){selector=selector.substr(1);tokens.push({type:"universal"})}else if(firstChar in attribSelectors){var _a=attribSelectors[firstChar],name_1=_a[0],action=_a[1];selector=selector.substr(1);tokens.push({type:"attribute",name:name_1,action:action,value:getName(),ignoreCase:false})}else if(firstChar==="["){selector=selector.substr(1);var data=selector.match(reAttr);if(!data){throw new Error("Malformed attribute selector: "+selector)}selector=selector.substr(data[0].length);var name_2=unescapeCSS(data[1]);if(!options||("lowerCaseAttributeNames"in options?options.lowerCaseAttributeNames:!options.xmlMode)){name_2=name_2.toLowerCase()}tokens.push({type:"attribute",name:name_2,action:actionTypes[data[2]],value:unescapeCSS(data[4]||data[5]||""),ignoreCase:!!data[6]})}else if(firstChar===":"){if(selector.charAt(1)===":"){selector=selector.substr(2);tokens.push({type:"pseudo-element",name:getName().toLowerCase()});continue}selector=selector.substr(1);var name_3=getName().toLowerCase();var data=null;if(selector.charAt(0)==="("){if(unpackPseudos.has(name_3)){var quot=selector.charAt(1);var quoted=quotes.has(quot);selector=selector.substr(quoted?2:1);data=[];selector=parseSelector(data,selector,options);if(quoted){if(selector.charAt(0)!==quot){throw new Error("Unmatched quotes in :"+name_3)}else{selector=selector.substr(1)}}if(selector.charAt(0)!==")"){throw new Error("Missing closing parenthesis in :"+name_3+" ("+selector+")")}selector=selector.substr(1)}else{var pos=1;var counter=1;for(;counter>0&&pos<selector.length;pos++){if(selector.charAt(pos)==="("&&!isEscaped(pos))counter++;else if(selector.charAt(pos)===")"&&!isEscaped(pos))counter--}if(counter){throw new Error("Parenthesis not matched")}data=selector.substr(1,pos-2);selector=selector.substr(pos);if(stripQuotesFromPseudos.has(name_3)){var quot=data.charAt(0);if(quot===data.slice(-1)&&quotes.has(quot)){data=data.slice(1,-1)}data=unescapeCSS(data)}}}tokens.push({type:"pseudo",name:name_3,data:data})}else if(reName.test(selector)){var name_4=getName();if(!options||("lowerCaseTags"in options?options.lowerCaseTags:!options.xmlMode)){name_4=name_4.toLowerCase()}tokens.push({type:"tag",name:name_4})}else{if(tokens.length&&tokens[tokens.length-1].type==="descendant"){tokens.pop()}addToken(subselects,tokens);return selector}}}addToken(subselects,tokens);return selector}function addToken(subselects,tokens){if(subselects.length>0&&tokens.length===0){throw new Error("Empty sub-selector")}subselects.push(tokens)}}));var stringify_1=createCommonjsModule((function(module,exports){Object.defineProperty(exports,"__esModule",{value:true});var actionTypes={equals:"",element:"~",start:"^",end:"$",any:"*",not:"!",hyphen:"|"};function stringify(token){return token.map(stringifySubselector).join(", ")}exports.default=stringify;function stringifySubselector(token){return token.map(stringifyToken).join("")}function stringifyToken(token){switch(token.type){case"child":return" > ";case"parent":return" < ";case"sibling":return" ~ ";case"adjacent":return" + ";case"descendant":return" ";case"universal":return"*";case"tag":return escapeName(token.name);case"pseudo-element":return"::"+escapeName(token.name);case"pseudo":if(token.data===null)return":"+escapeName(token.name);if(typeof token.data==="string"){return":"+escapeName(token.name)+"("+token.data+")"}return":"+escapeName(token.name)+"("+stringify(token.data)+")";case"attribute":if(token.action==="exists"){return"["+escapeName(token.name)+"]"}if(token.name==="id"&&token.action==="equals"&&!token.ignoreCase){return"#"+escapeName(token.value)}if(token.name==="class"&&token.action==="element"&&!token.ignoreCase){return"."+escapeName(token.value)}return"["+escapeName(token.name)+actionTypes[token.action]+"='"+escapeName(token.value)+"'"+(token.ignoreCase?"i":"")+"]";default:throw new Error("Unknown type")}}function escapeName(str){return str}}));var lib=createCommonjsModule((function(module,exports){var __createBinding=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;Object.defineProperty(o,k2,{enumerable:true,get:function(){return m[k]}})}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]});var __exportStar=commonjsGlobal&&commonjsGlobal.__exportStar||function(m,exports){for(var p in m)if(p!=="default"&&!exports.hasOwnProperty(p))__createBinding(exports,m,p)};Object.defineProperty(exports,"__esModule",{value:true});__exportStar(parse_1,exports);var parse_1$1=parse_1;Object.defineProperty(exports,"parse",{enumerable:true,get:function(){return parse_1$1.default}});Object.defineProperty(exports,"stringify",{enumerable:true,get:function(){return stringify_1.default}})}));var universal=50;var tag=30;var attribute=1;var pseudo=0;var descendant=-1;var child=-1;var parent=-1;var sibling=-1;var adjacent=-1;var procedure={universal:universal,tag:tag,attribute:attribute,pseudo:pseudo,descendant:descendant,child:child,parent:parent,sibling:sibling,adjacent:adjacent};var sort=sortByProcedure;var attributes={__proto__:null,exists:10,equals:8,not:7,start:6,end:6,any:5,hyphen:4,element:4};function sortByProcedure(arr){var procs=arr.map(getProcedure);for(var i=1;i<arr.length;i++){var procNew=procs[i];if(procNew<0)continue;for(var j=i-1;j>=0&&procNew<procs[j];j--){var token=arr[j+1];arr[j+1]=arr[j];arr[j]=token;procs[j+1]=procs[j];procs[j]=procNew}}}function getProcedure(token){var proc=procedure[token.type];if(proc===procedure.attribute){proc=attributes[token.action];if(proc===attributes.equals&&token.name==="id"){proc=9}if(token.ignoreCase){proc>>=1}}else if(proc===procedure.pseudo){if(!token.data){proc=3}else if(token.name==="has"||token.name==="contains"){proc=0}else if(token.name==="matches"||token.name==="not"){proc=0;for(var i=0;i<token.data.length;i++){if(token.data[i].length!==1)continue;var cur=getProcedure(token.data[i][0]);if(cur===0){proc=0;break}if(cur>proc)proc=cur}if(token.data.length>1&&proc>0)proc-=1}else{proc=1}}return proc}var falseFunc=boolbase.falseFunc;var reChars=/[-[\]{}()*+?.,\\^$|#\s]/g;var attributeRules={__proto__:null,equals:function(next,data,options){var name=data.name;var value=data.value;var adapter=options.adapter;if(data.ignoreCase){value=value.toLowerCase();return function equalsIC(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.toLowerCase()===value&&next(elem)}}return function equals(elem){return adapter.getAttributeValue(elem,name)===value&&next(elem)}},hyphen:function(next,data,options){var name=data.name;var value=data.value;var len=value.length;var adapter=options.adapter;if(data.ignoreCase){value=value.toLowerCase();return function hyphenIC(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&(attr.length===len||attr.charAt(len)==="-")&&attr.substr(0,len).toLowerCase()===value&&next(elem)}}return function hyphen(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.substr(0,len)===value&&(attr.length===len||attr.charAt(len)==="-")&&next(elem)}},element:function(next,data,options){var name=data.name;var value=data.value;var adapter=options.adapter;if(/\s/.test(value)){return falseFunc}value=value.replace(reChars,"\\$&");var pattern="(?:^|\\s)"+value+"(?:$|\\s)",flags=data.ignoreCase?"i":"",regex=new RegExp(pattern,flags);return function element(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&regex.test(attr)&&next(elem)}},exists:function(next,data,options){var name=data.name;var adapter=options.adapter;return function exists(elem){return adapter.hasAttrib(elem,name)&&next(elem)}},start:function(next,data,options){var name=data.name;var value=data.value;var len=value.length;var adapter=options.adapter;if(len===0){return falseFunc}if(data.ignoreCase){value=value.toLowerCase();return function startIC(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.substr(0,len).toLowerCase()===value&&next(elem)}}return function start(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.substr(0,len)===value&&next(elem)}},end:function(next,data,options){var name=data.name;var value=data.value;var len=-value.length;var adapter=options.adapter;if(len===0){return falseFunc}if(data.ignoreCase){value=value.toLowerCase();return function endIC(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.substr(len).toLowerCase()===value&&next(elem)}}return function end(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.substr(len)===value&&next(elem)}},any:function(next,data,options){var name=data.name;var value=data.value;var adapter=options.adapter;if(value===""){return falseFunc}if(data.ignoreCase){var regex=new RegExp(value.replace(reChars,"\\$&"),"i");return function anyIC(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&regex.test(attr)&&next(elem)}}return function any(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.indexOf(value)>=0&&next(elem)}},not:function(next,data,options){var name=data.name;var value=data.value;var adapter=options.adapter;if(value===""){return function notEmpty(elem){return!!adapter.getAttributeValue(elem,name)&&next(elem)}}else if(data.ignoreCase){value=value.toLowerCase();return function notIC(elem){var attr=adapter.getAttributeValue(elem,name);return attr!=null&&attr.toLowerCase()!==value&&next(elem)}}return function not(elem){return adapter.getAttributeValue(elem,name)!==value&&next(elem)}}};var attributes$1={compile:function(next,data,options){if(options&&options.strict&&(data.ignoreCase||data.action==="not")){throw new Error("Unsupported attribute selector")}return attributeRules[data.action](next,data,options)},rules:attributeRules};var parse_1$1=parse;var re_nthElement=/^([+\-]?\d*n)?\s*(?:([+\-]?)\s*(\d+))?$/;function parse(formula){formula=formula.trim().toLowerCase();if(formula==="even"){return[2,0]}else if(formula==="odd"){return[2,1]}else{var parsed=formula.match(re_nthElement);if(!parsed){throw new SyntaxError("n-th rule couldn't be par